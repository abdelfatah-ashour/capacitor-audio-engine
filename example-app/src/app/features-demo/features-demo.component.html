<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Native Audio Engine Demo</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Permission Check Section -->
  <ion-button expand="block" fill="outline" color="medium" (click)="openSettings()">
    <ion-icon name="settings" slot="start"></ion-icon>
    Open App Permissions
  </ion-button>
  <ion-button expand="block" fill="outline" color="medium" (click)="checkPermission()">
    Check Permission
  </ion-button>
  @if (!hasPermission()) {
    <ion-card color="warning">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="settings"></ion-icon>
          Microphone Permission Required
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>This app needs microphone permission to record audio.</p>
        <ion-button expand="block" fill="solid" (click)="requestPermission()">
          Request Permission
        </ion-button>
        <ion-note>
          <p>
            <small
              >If permission was denied, you can open app permissions to manually enable microphone
              access.</small
            >
          </p>
        </ion-note>
      </ion-card-content>
    </ion-card>
  } @else {
    <!-- Main Content -->
    <div>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="recording"
        (click)="selectTab('recording')"
      >
        <ion-icon name="mic-circle"></ion-icon>
        <ion-label>Recording</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="playback"
        (click)="selectTab('playback')"
      >
        <ion-icon name="musical-notes"></ion-icon>
        <ion-label>Playback</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="microphones"
        (click)="selectTab('microphones')"
      >
        <ion-icon name="volume-high"></ion-icon>
        <ion-label>Microphones</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="audio-info"
        (click)="selectTab('audio-info')"
      >
        <ion-icon name="information-circle"></ion-icon>
        <ion-label>Audio Info</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="waveform"
        (click)="selectTab('waveform')"
      >
        <ion-icon name="pulse"></ion-icon>
        <ion-label>Waveform</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="intelligent-waveform"
        (click)="selectTab('intelligent-waveform')"
      >
        <ion-icon name="analytics"></ion-icon>
        <ion-label>Smart Buffer</ion-label>
      </ion-button>
    </div>
    {{ activeTab() }}

    <!-- Recording Tab -->
    @if (activeTab() === 'recording') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="mic-circle"></ion-icon>
            Audio Recording
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          {{ recordingStatus() }}
          <!-- Recording Status -->
          <div class="recording-status">
            <ion-chip
              [color]="
                recordingStatus() === 'recording'
                  ? 'danger'
                  : recordingStatus() === 'paused'
                    ? 'warning'
                    : 'medium'
              "
            >
              @if (recordingStatus() === 'recording') {
                <ion-icon name="mic-circle"></ion-icon>
                <ion-label>Recording</ion-label>
              } @else if (recordingStatus() === 'paused') {
                <ion-icon name="micOffCircle"></ion-icon>
                <ion-label>Paused</ion-label>
              } @else {
                <ion-icon name="mic-off-circle"></ion-icon>
                <ion-label>Idle</ion-label>
              }
            </ion-chip>

            @if (recordingDuration() > 0) {
              <ion-note>{{ formattedDuration() }}</ion-note>
            }
          </div>

          <!-- Recording Controls -->
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-button expand="block" [disabled]="!canRecord()" (click)="startRecording()">
                  <ion-icon name="mic-circle" slot="start"></ion-icon>
                  Start Recording
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button
                  expand="block"
                  color="warning"
                  [disabled]="!canPause()"
                  (click)="pauseRecording()"
                >
                  <ion-icon name="mic-off-circle" slot="start"></ion-icon>
                  Pause
                </ion-button>
              </ion-col>
            </ion-row>
            <ion-row>
              <ion-col size="4">
                <ion-button
                  expand="block"
                  color="success"
                  [disabled]="!canResume()"
                  (click)="resumeRecording()"
                >
                  <ion-icon name="mic-circle" slot="start"></ion-icon>
                  Resume
                </ion-button>
              </ion-col>
              <ion-col size="4">
                <ion-button
                  expand="block"
                  color="danger"
                  [disabled]="!canStop()"
                  (click)="stopRecording()"
                >
                  <ion-icon name="mic-off-circle" slot="start"></ion-icon>
                  Stop
                </ion-button>
              </ion-col>
              <ion-col size="4">
                <ion-button
                  expand="block"
                  color="medium"
                  [disabled]="!canReset()"
                  (click)="resetRecording()"
                >
                  <ion-icon name="refresh" slot="start"></ion-icon>
                  Reset
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>

          <!-- Recording Options -->
          @if (recordingStatus() === 'idle') {
            <ion-card color="light">
              <ion-card-header>
                <ion-card-title>Recording Options</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <!-- Quality Presets -->
                <ion-item>
                  <ion-label>Quality Presets</ion-label>
                  <ion-note>{{ selectedQualityPreset() || 'Custom' }}</ion-note>
                </ion-item>
                <ion-item>
                  <ion-grid>
                    <ion-row>
                      @for (preset of qualityPresetOptions; track preset.value) {
                        <ion-col size="4">
                          <ion-button
                            size="small"
                            [fill]="selectedQualityPreset() === preset.value ? 'solid' : 'outline'"
                            [color]="
                              selectedQualityPreset() === preset.value ? 'primary' : 'medium'
                            "
                            (click)="updateQualityPreset(preset.value)"
                          >
                            {{ preset.label }}
                          </ion-button>
                        </ion-col>
                      }
                    </ion-row>
                    <ion-row>
                      <ion-col>
                        <ion-note class="ion-text-center">
                          {{ selectedQualityDescription() }}
                        </ion-note>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </ion-item>

                <ion-item>
                  <ion-label>Sample Rate (Hz)</ion-label>
                  <ion-note>{{ recordingOptions().sampleRate }} Hz</ion-note>
                </ion-item>
                <ion-item>
                  <ion-grid>
                    <ion-row>
                      @for (rate of sampleRateOptions; track rate.value) {
                        <ion-col size="2.4">
                          <ion-button
                            size="small"
                            [fill]="
                              recordingOptions().sampleRate === rate.value ? 'solid' : 'outline'
                            "
                            [color]="
                              recordingOptions().sampleRate === rate.value ? 'primary' : 'medium'
                            "
                            (click)="updateSampleRate(rate.value)"
                          >
                            {{ rate.label }}
                          </ion-button>
                        </ion-col>
                      }
                    </ion-row>
                  </ion-grid>
                </ion-item>

                <ion-item>
                  <ion-label>Channels</ion-label>
                  <ion-note>{{ recordingOptions().channels === 1 ? 'Mono' : 'Stereo' }}</ion-note>
                </ion-item>
                <ion-item>
                  <ion-grid>
                    <ion-row>
                      @for (channel of channelOptions; track channel.value) {
                        <ion-col size="6">
                          <ion-button
                            expand="block"
                            [fill]="
                              recordingOptions().channels === channel.value ? 'solid' : 'outline'
                            "
                            [color]="
                              recordingOptions().channels === channel.value ? 'primary' : 'medium'
                            "
                            (click)="updateChannels(channel.value)"
                          >
                            {{ channel.label }}
                          </ion-button>
                        </ion-col>
                      }
                    </ion-row>
                  </ion-grid>
                </ion-item>

                <ion-item>
                  <ion-label>Bitrate (bps)</ion-label>
                  <ion-note>{{ recordingOptions().bitrate! / 1000 }}k bps</ion-note>
                </ion-item>
                <ion-item>
                  <ion-grid>
                    <ion-row>
                      @for (bitrate of bitrateOptions; track bitrate.value) {
                        <ion-col size="2.4">
                          <ion-button
                            size="small"
                            [fill]="
                              recordingOptions().bitrate === bitrate.value ? 'solid' : 'outline'
                            "
                            [color]="
                              recordingOptions().bitrate === bitrate.value ? 'primary' : 'medium'
                            "
                            (click)="updateBitrate(bitrate.value)"
                          >
                            {{ bitrate.label }}
                          </ion-button>
                        </ion-col>
                      }
                    </ion-row>
                  </ion-grid>
                </ion-item>

                <ion-item>
                  <ion-checkbox
                    [checked]="isSegmentRollingEnabled()"
                    (ionChange)="isSegmentRollingEnabled.set($event.detail.checked)"
                  ></ion-checkbox>
                  <ion-label>Enable Segment Rolling</ion-label>
                </ion-item>

                @if (isSegmentRollingEnabled()) {
                  <ion-item>
                    <ion-label>Max Duration (seconds)</ion-label>
                    <ion-note>{{ maxDurationSeconds() }}s</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-grid>
                      <ion-row>
                        @for (duration of maxDurationOptions; track duration.value) {
                          <ion-col size="3">
                            <ion-button
                              size="small"
                              [fill]="maxDurationSeconds() === duration.value ? 'solid' : 'outline'"
                              [color]="
                                maxDurationSeconds() === duration.value ? 'primary' : 'medium'
                              "
                              (click)="updateMaxDuration(duration.value)"
                            >
                              {{ duration.label }}
                            </ion-button>
                          </ion-col>
                        }
                      </ion-row>
                    </ion-grid>
                  </ion-item>
                }
              </ion-card-content>
            </ion-card>
          }

          <!-- Recording Progress (for segment rolling) -->
          @if (isSegmentRollingEnabled() && recordingStatus() !== 'idle') {
            <ion-card>
              <ion-card-content>
                <ion-label>Recording Progress</ion-label>
                <ion-progress-bar [value]="recordingProgressPercent() / 100"></ion-progress-bar>
                <ion-note>{{ recordingProgressPercent().toFixed(1) }}% complete</ion-note>
              </ion-card-content>
            </ion-card>
          }

          <!-- Recorded Files -->
          @if (recordedFiles().length > 0) {
            <ion-card>
              <ion-card-header>
                <ion-card-title>Recorded Files</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <!-- Current playback status for recorded audio -->
                @if (currentRecordedFile() && recordedPlaylistInitialized()) {
                  <ion-card color="light">
                    <ion-card-content>
                      <h4>Now Playing: {{ currentRecordedFile()?.filename }}</h4>
                      <ion-progress-bar
                        [value]="recordedPlaybackProgress() / 100"
                      ></ion-progress-bar>
                      <ion-note>{{ formattedRecordedPlaybackTime() }}</ion-note>

                      <!-- Playback controls -->
                      <ion-grid style="margin-top: 10px">
                        <ion-row>
                          <ion-col size="4">
                            @if (isRecordedAudioPlaying()) {
                              <ion-button
                                expand="block"
                                fill="solid"
                                (click)="pauseRecordedAudio()"
                              >
                                <ion-icon name="pause"></ion-icon>
                              </ion-button>
                            } @else {
                              <ion-button expand="block" fill="solid" (click)="playRecordedAudio()">
                                <ion-icon name="play"></ion-icon>
                              </ion-button>
                            }
                          </ion-col>
                          <ion-col size="4">
                            <ion-button expand="block" fill="outline" (click)="stopRecordedAudio()">
                              <ion-icon name="stop"></ion-icon>
                            </ion-button>
                          </ion-col>
                          <ion-col size="4">
                            <ion-button
                              expand="block"
                              fill="outline"
                              (click)="seekRecordedAudio(0)"
                            >
                              <ion-icon name="refresh"></ion-icon>
                            </ion-button>
                          </ion-col>
                        </ion-row>
                      </ion-grid>
                    </ion-card-content>
                  </ion-card>
                }

                <ion-list>
                  @for (file of recordedFiles(); track file.uri) {
                    <ion-item>
                      <ion-label>
                        <h3>{{ file.filename }}</h3>
                        <p>Duration: {{ formatTime(file.duration) }}</p>
                        <p>Size: {{ formatFileSize(file.size) }}</p>
                        @if (file.isSegmentRolled) {
                          <ion-chip color="primary" size="small">
                            <ion-label>Segment Rolled</ion-label>
                          </ion-chip>
                        }
                        @if (isFilePreloaded(file.uri)) {
                          <ion-chip color="success" size="small">
                            <ion-icon name="checkmark-circle"></ion-icon>
                            <ion-label>Preloaded</ion-label>
                          </ion-chip>
                        }
                        @if (isCurrentlyPlaying(file)) {
                          <ion-chip color="warning" size="small">
                            <ion-icon name="play"></ion-icon>
                            <ion-label>Playing</ion-label>
                          </ion-chip>
                        }
                      </ion-label>

                      <!-- Action buttons -->
                      <div slot="end" style="display: flex; gap: 8px">
                        @if (!isFilePreloaded(file.uri)) {
                          <ion-button fill="clear" (click)="preloadRecordedAudio(file)">
                            <ion-icon name="download"></ion-icon>
                          </ion-button>
                        }

                        @if (isCurrentlyPlaying(file)) {
                          <ion-button fill="clear" color="warning" (click)="pauseRecordedAudio()">
                            <ion-icon name="pause"></ion-icon>
                          </ion-button>
                        } @else {
                          <ion-button
                            fill="clear"
                            color="success"
                            (click)="playRecordedAudio(file)"
                          >
                            <ion-icon name="play"></ion-icon>
                          </ion-button>
                        }

                        <ion-button fill="clear" (click)="trimAudio(file)">
                          <ion-icon name="cut"></ion-icon>
                        </ion-button>
                      </div>
                    </ion-item>
                  }
                </ion-list>
              </ion-card-content>
            </ion-card>
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- Per-URL Playback Tab -->
    @if (activeTab() === 'playback') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="musical-notes"></ion-icon>
            Per-URL Audio Playback Demo
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>Independent playback controls for each demo track</p>

          <!-- Global Controls -->
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-button expand="block" fill="outline" (click)="preloadAllTracks()">
                  <ion-icon name="download" slot="start"></ion-icon>
                  Preload All Tracks
                </ion-button>
              </ion-col>
              <ion-col size="6">
                @if (realtimeUpdatesActive()) {
                  <ion-chip color="success">
                    <ion-icon name="refresh"></ion-icon>
                    <ion-label>Live Updates Active</ion-label>
                  </ion-chip>
                }
              </ion-col>
            </ion-row>
          </ion-grid>

          <!-- Individual Track Controls -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>Demo Tracks</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              @for (track of demoPlaylist; track track.id) {
                <ion-card class="track-player-card">
                  <ion-card-header>
                    <ion-card-title>{{ track.title }}</ion-card-title>
                    <ion-note>{{ track.artist }}</ion-note>

                    <!-- Track Status Chips -->
                    <div class="track-status">
                      @if (isTrackPreloaded(track.url)) {
                        <ion-chip color="success" size="small">
                          <ion-icon name="checkmark-circle"></ion-icon>
                          <ion-label>Preloaded</ion-label>
                        </ion-chip>
                      }

                      @if (getPreloadedTrackInfo(track.url); as trackInfo) {
                        @if (trackInfo.loaded) {
                          @if (trackInfo.duration && trackInfo.duration > 0) {
                            <ion-chip color="medium" size="small">
                              <ion-label>{{ formatTime(trackInfo.duration) }}</ion-label>
                            </ion-chip>
                          }
                        } @else {
                          <ion-chip color="danger" size="small">
                            <ion-label>Failed to Load</ion-label>
                          </ion-chip>
                        }
                      }
                    </div>
                  </ion-card-header>

                  <ion-card-content>
                    @if (!isTrackPreloaded(track.url)) {
                      <!-- Preload Section -->
                      <div class="preload-section">
                        <ion-button expand="block" fill="outline" (click)="preloadTrack(track.url)">
                          <ion-icon name="download" slot="start"></ion-icon>
                          Load Track
                        </ion-button>
                      </div>
                    } @else {
                      <!-- Player Controls Section -->
                      <div class="player-controls">
                        <!-- Progress Bar Section -->
                        @if (getTrackPlaybackInfo(track.url)) {
                          <div class="progress-section">
                            <ion-range
                              [value]="getTrackProgress(track.url)"
                              [min]="0"
                              [max]="100"
                              [pin]="true"
                              [snaps]="false"
                              [ticks]="false"
                              (ionInput)="onSeekChange($event, track.url)"
                              color="primary"
                            >
                              <ion-label slot="start">{{
                                formatTime(getTrackPosition(track.url))
                              }}</ion-label>
                              <ion-label slot="end">{{
                                formatTime(getTrackDuration(track.url))
                              }}</ion-label>
                            </ion-range>
                          </div>
                        }

                        <!-- Main Control Buttons -->
                        <div class="control-buttons">
                          <ion-grid>
                            <ion-row>
                              <ion-col size="3">
                                <ion-button
                                  expand="block"
                                  fill="solid"
                                  color="success"
                                  [disabled]="isTrackPlaying(track.url)"
                                  (click)="playTrack(track.url)"
                                >
                                  <ion-icon name="play"></ion-icon>
                                </ion-button>
                                <ion-label class="button-label">Play</ion-label>
                              </ion-col>
                              <ion-col size="3">
                                <ion-button
                                  expand="block"
                                  fill="solid"
                                  color="warning"
                                  [disabled]="!isTrackPlaying(track.url)"
                                  (click)="pauseTrack(track.url)"
                                >
                                  <ion-icon name="pause"></ion-icon>
                                </ion-button>
                                <ion-label class="button-label">Pause</ion-label>
                              </ion-col>
                              <ion-col size="3">
                                <ion-button
                                  expand="block"
                                  fill="solid"
                                  color="secondary"
                                  [disabled]="
                                    !getTrackPlaybackInfo(track.url) || isTrackPlaying(track.url)
                                  "
                                  (click)="resumeTrack(track.url)"
                                >
                                  <ion-icon name="play"></ion-icon>
                                </ion-button>
                                <ion-label class="button-label">Resume</ion-label>
                              </ion-col>
                              <ion-col size="3">
                                <ion-button
                                  expand="block"
                                  fill="solid"
                                  color="danger"
                                  [disabled]="!getTrackPlaybackInfo(track.url)"
                                  (click)="stopTrack(track.url)"
                                >
                                  <ion-icon name="stop"></ion-icon>
                                </ion-button>
                                <ion-label class="button-label">Stop</ion-label>
                              </ion-col>
                            </ion-row>
                          </ion-grid>
                        </div>

                        <!-- Quick Seek Buttons -->
                        @if (getTrackPlaybackInfo(track.url)) {
                          <div class="seek-buttons">
                            <ion-label><strong>Quick Seek:</strong></ion-label>
                            <ion-grid>
                              <ion-row>
                                <ion-col size="2.4">
                                  <ion-button
                                    size="small"
                                    fill="clear"
                                    (click)="seekTrack(track.url, 0)"
                                  >
                                    Start
                                  </ion-button>
                                </ion-col>
                                <ion-col size="2.4">
                                  <ion-button
                                    size="small"
                                    fill="clear"
                                    (click)="seekTrack(track.url, 15)"
                                  >
                                    15s
                                  </ion-button>
                                </ion-col>
                                <ion-col size="2.4">
                                  <ion-button
                                    size="small"
                                    fill="clear"
                                    (click)="seekTrack(track.url, 30)"
                                  >
                                    30s
                                  </ion-button>
                                </ion-col>
                                <ion-col size="2.4">
                                  <ion-button
                                    size="small"
                                    fill="clear"
                                    (click)="seekTrack(track.url, 60)"
                                  >
                                    60s
                                  </ion-button>
                                </ion-col>
                                <ion-col size="2.4">
                                  <ion-button
                                    size="small"
                                    fill="clear"
                                    (click)="seekTrack(track.url, getTrackDuration(track.url) / 2)"
                                  >
                                    50%
                                  </ion-button>
                                </ion-col>
                              </ion-row>
                            </ion-grid>
                          </div>
                        }
                      </div>
                    }
                  </ion-card-content>
                </ion-card>
              }
            </ion-card-content>
          </ion-card>

          <!-- Summary Status -->
          <ion-card class="playback-summary">
            <ion-card-header>
              <ion-card-title>Playback Summary</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-label>Preloaded Tracks</ion-label>
                <ion-chip [color]="hasPreloadedTracks() ? 'success' : 'medium'">
                  {{ preloadedTracks().size }} of {{ demoPlaylist.length }}
                </ion-chip>
              </ion-item>
              <ion-item>
                <ion-label>Currently Playing</ion-label>
                <ion-note>{{ getCurrentlyPlayingTrack() }}</ion-note>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <!-- Detailed Track Information -->
          @if (preloadedTrackInfo().length > 0) {
            <ion-card>
              <ion-card-header>
                <ion-card-title>
                  <ion-icon name="information-circle"></ion-icon>
                  Preloaded Track Details
                </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <ion-list>
                  @for (trackInfo of preloadedTrackInfo(); track trackInfo.url) {
                    <ion-item>
                      <ion-label>
                        <h3>{{ getTrackTitleByUrl(trackInfo.url) }}</h3>

                        <!-- Load Status -->
                        @if (trackInfo.loaded) {
                          <ion-chip color="success" size="small">
                            <ion-icon name="checkmark-circle"></ion-icon>
                            <ion-label>Loaded Successfully</ion-label>
                          </ion-chip>
                        } @else {
                          <ion-chip color="danger" size="small">
                            <ion-icon name="close-circle"></ion-icon>
                            <ion-label>Failed to Load</ion-label>
                          </ion-chip>
                        }

                        <!-- Track Details (only show if loaded) -->
                        @if (trackInfo.loaded) {
                          <div style="margin-top: 8px">
                            @if (trackInfo.mimeType) {
                              <p><strong>Format:</strong> {{ trackInfo.mimeType }}</p>
                            }
                            @if (trackInfo.duration && trackInfo.duration > 0) {
                              <p><strong>Duration:</strong> {{ formatTime(trackInfo.duration) }}</p>
                            }
                            @if (trackInfo.size && trackInfo.size > 0) {
                              <p>
                                <strong>File Size:</strong> {{ formatFileSize(trackInfo.size) }}
                              </p>
                            }
                          </div>
                        }
                      </ion-label>

                      <!-- Status Indicator -->
                      <div slot="end">
                        @if (trackInfo.loaded) {
                          <ion-icon name="checkmark-circle" color="success"></ion-icon>
                        } @else {
                          <ion-icon name="close-circle" color="danger"></ion-icon>
                        }
                      </div>
                    </ion-item>
                  }
                </ion-list>
              </ion-card-content>
            </ion-card>
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- Microphones Tab -->
    @if (activeTab() === 'microphones') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="volume-high"></ion-icon>
            Microphone Management
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-button expand="block" fill="outline" (click)="loadAvailableMicrophones()">
            <ion-icon name="refresh" slot="start"></ion-icon>
            Refresh Microphones
          </ion-button>

          <ion-button expand="block" fill="outline" (click)="checkMicrophoneStatus()">
            <ion-icon name="informationCircle" slot="start"></ion-icon>
            Check Microphone Status
          </ion-button>

          @if (microphoneBusy()) {
            <ion-card color="warning">
              <ion-card-content>
                <p>⚠️ Microphone is currently busy or in use by another application.</p>
              </ion-card-content>
            </ion-card>
          }

          @if (availableMicrophones().length > 0) {
            <ion-list>
              <ion-item-group>
                <ion-item-divider>
                  <ion-label>Available Microphones</ion-label>
                </ion-item-divider>
                @for (mic of availableMicrophones(); track mic.id) {
                  <ion-item (click)="switchMicrophone(mic.id)">
                    <ion-label>
                      <h3>{{ mic.name }}</h3>
                      <p>Type: {{ mic.type | titlecase }}</p>
                      @if (mic.description) {
                        <p>{{ mic.description }}</p>
                      }
                    </ion-label>
                    @if (currentMicrophone() === mic.id) {
                      <ion-chip color="success" slot="end">
                        <ion-label>Active</ion-label>
                      </ion-chip>
                    }
                  </ion-item>
                }
              </ion-item-group>
            </ion-list>
          } @else {
            <ion-card color="light">
              <ion-card-content>
                <p>
                  No microphones detected. Click "Refresh Microphones" to scan for available
                  devices.
                </p>
              </ion-card-content>
            </ion-card>
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- Audio Info Tab -->
    @if (activeTab() === 'audio-info') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="information-circle"></ion-icon>
            Audio File Information
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @if (recordedFiles().length > 0) {
            <ion-list>
              @for (file of recordedFiles(); track file.uri) {
                <ion-item (click)="selectedAudioInfo.set(file)">
                  <ion-label>
                    <h3>{{ file.filename }}</h3>
                    <p>{{ formatTime(file.duration) }} • {{ formatFileSize(file.size) }}</p>
                  </ion-label>
                  @if (selectedAudioInfo() === file) {
                    <ion-icon name="checkmarkCircle" color="success" slot="end"></ion-icon>
                  }
                </ion-item>
              }
            </ion-list>

            @if (selectedAudioInfo()) {
              <ion-card color="light">
                <ion-card-header>
                  <ion-card-title>{{ selectedAudioInfo()!.filename }}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                  <ion-grid>
                    <ion-row>
                      <ion-col size="6">
                        <ion-label>
                          <h3>Duration</h3>
                          <p>{{ formatTime(selectedAudioInfo()!.duration) }}</p>
                        </ion-label>
                      </ion-col>
                      <ion-col size="6">
                        <ion-label>
                          <h3>File Size</h3>
                          <p>{{ formatFileSize(selectedAudioInfo()!.size) }}</p>
                        </ion-label>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="6">
                        <ion-label>
                          <h3>Sample Rate</h3>
                          <p>{{ selectedAudioInfo()!.sampleRate }} Hz</p>
                        </ion-label>
                      </ion-col>
                      <ion-col size="6">
                        <ion-label>
                          <h3>Channels</h3>
                          <p>{{ selectedAudioInfo()!.channels === 1 ? 'Mono' : 'Stereo' }}</p>
                        </ion-label>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="6">
                        <ion-label>
                          <h3>Bitrate</h3>
                          <p>{{ selectedAudioInfo()!.bitrate / 1000 }}k bps</p>
                        </ion-label>
                      </ion-col>
                      <ion-col size="6">
                        <ion-label>
                          <h3>MIME Type</h3>
                          <p>{{ selectedAudioInfo()!.mimeType }}</p>
                        </ion-label>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <ion-label>
                          <h3>File Path</h3>
                          <p style="word-break: break-all">{{ selectedAudioInfo()!.path }}</p>
                        </ion-label>
                      </ion-col>
                    </ion-row>
                    @if (selectedAudioInfo()!.isSegmentRolled) {
                      <ion-row>
                        <ion-col size="12">
                          <ion-chip color="primary">
                            <ion-icon name="time"></ion-icon>
                            <ion-label>Segment Rolled Recording</ion-label>
                          </ion-chip>
                          <p>Max Duration: {{ selectedAudioInfo()!.maxDurationSeconds }}s</p>
                        </ion-col>
                      </ion-row>
                    }
                  </ion-grid>
                </ion-card-content>
              </ion-card>
            }
          } @else {
            <ion-card color="light">
              <ion-card-content>
                <p>
                  No recorded files available. Record some audio first to see detailed information
                  here.
                </p>
              </ion-card-content>
            </ion-card>
          }
        </ion-card-content>
      </ion-card>

      <!-- App Permissions Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="settings"></ion-icon>
            App Permissions
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>Manage app permissions directly from your device's system settings.</p>
          <ion-button expand="block" fill="outline" (click)="openSettings()"
            >>>
            <ion-icon name="settings" slot="start"></ion-icon>
            Open App Permissions
          </ion-button>
          <ion-note>
            <p>
              <small>
                Use this to modify microphone permissions, notification settings, and other
                app-specific configurations. This is especially useful if you initially denied
                permissions and want to enable them later.
              </small>
            </p>
          </ion-note>
        </ion-card-content>
      </ion-card>
    }

    <!-- Waveform Tab -->
    @if (activeTab() === 'waveform') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="pulse"></ion-icon>
            Growing Waveform Visualization with Speech Detection
          </ion-card-title>
          <ion-card-subtitle>
            Real-time incremental audio levels with optional speech-only detection and Voice
            Activity Detection (VAD)
          </ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <!-- Unified Configuration -->
          <ion-card color="primary">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="settings" slot="start"></ion-icon>
                Unified Waveform Configuration
              </ion-card-title>
              <ion-card-subtitle>
                Configure all waveform features in one call using the new unified API
              </ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <ion-button
                expand="block"
                fill="solid"
                color="success"
                (click)="configureUnifiedWaveform()"
              >
                <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                Apply Unified Configuration
              </ion-button>
              <ion-note color="medium">
                <small>
                  This uses the new unified API that combines waveform, speech detection, VAD
                  settings, and gain factor for better visualization.
                </small>
              </ion-note>
            </ion-card-content>
          </ion-card>

          <!-- Legacy Configuration -->
          <ion-accordion-group>
            <ion-accordion value="legacy">
              <ion-item slot="header" color="light">
                <ion-label>Legacy Configuration (Deprecated)</ion-label>
              </ion-item>
              <div slot="content">
                <!-- Waveform Controls -->
                <div class="waveform-controls">
                  <ion-item>
                    <ion-checkbox
                      [checked]="waveformEnabled()"
                      (ionChange)="toggleWaveformEnabled()"
                    >
                    </ion-checkbox>
                    <ion-label class="ion-margin-start">Enable Waveform</ion-label>
                  </ion-item>

                  <ion-item>
                    <ion-label>Number of Bars: {{ waveformBars() }}</ion-label>
                    <ion-select
                      [value]="waveformBars()"
                      (ionChange)="updateWaveformBars($event.detail.value)"
                      interface="popover"
                    >
                      @for (option of waveformBarsOptions; track option) {
                        <ion-select-option [value]="option.value">{{
                          option.label
                        }}</ion-select-option>
                      }
                    </ion-select>
                  </ion-item>

                  <ion-item>
                    <ion-label>Emission Interval: {{ waveformIntervalSeconds() }}s</ion-label>
                  </ion-item>

                  <ion-button expand="block" fill="outline" (click)="resetWaveformLevels()">
                    <ion-icon name="refresh" slot="start"></ion-icon>
                    Reset Levels
                  </ion-button>

                  <ion-button
                    expand="block"
                    fill="clear"
                    color="danger"
                    (click)="destroyWaveform()"
                  >
                    <ion-icon name="close-circle" slot="start"></ion-icon>
                    Destroy Waveform
                  </ion-button>
                </div>

                <!-- Speech Detection Controls -->
                <div class="speech-detection-controls">
                  <ion-item-divider>
                    <ion-label>Speech Detection Settings</ion-label>
                  </ion-item-divider>

                  <ion-item>
                    <ion-checkbox
                      [checked]="speechDetectionEnabled()"
                      (ionChange)="toggleSpeechDetection()"
                    >
                    </ion-checkbox>
                    <ion-label class="ion-margin-start">Enable Speech-Only Detection</ion-label>
                  </ion-item>

                  @if (speechDetectionEnabled()) {
                    <ion-item>
                      <ion-label>Threshold: {{ speechThreshold() }}</ion-label>
                      <ion-select
                        [value]="speechThreshold()"
                        (ionChange)="updateSpeechThreshold($event.detail.value)"
                        interface="popover"
                      >
                        @for (option of speechThresholdOptions; track option) {
                          <ion-select-option [value]="option.value">{{
                            option.label
                          }}</ion-select-option>
                        }
                      </ion-select>
                    </ion-item>

                    <ion-item>
                      <ion-checkbox [checked]="useVAD()" (ionChange)="toggleVAD()"> </ion-checkbox>
                      <ion-label class="ion-margin-start"
                        >Use Voice Activity Detection (VAD)</ion-label
                      >
                    </ion-item>

                    @if (useVAD()) {
                      <ion-item>
                        <ion-label>Background Calibration: {{ calibrationDuration() }}ms</ion-label>
                        <ion-select
                          [value]="calibrationDuration()"
                          (ionChange)="updateCalibrationDuration($event.detail.value)"
                          interface="popover"
                        >
                          @for (option of calibrationDurationOptions; track option) {
                            <ion-select-option [value]="option.value">{{
                              option.label
                            }}</ion-select-option>
                          }
                        </ion-select>
                      </ion-item>

                      <!-- Advanced VAD Controls -->
                      <ion-item-divider color="light">
                        <ion-label>Advanced VAD Optimization</ion-label>
                      </ion-item-divider>

                      <ion-item>
                        <ion-note color="medium">
                          Configure VAD for optimal latency and noise rejection. Lower window sizes
                          reduce latency but may increase false positives.
                        </ion-note>
                      </ion-item>

                      <ion-card color="light">
                        <ion-card-content>
                          <h4>Advanced VAD Features</h4>
                          <ul>
                            <li>
                              <strong>Window Size:</strong> 3-20 frames (150ms-1000ms latency)
                            </li>
                            <li>
                              <strong>Voice Filter:</strong> Isolates human voice frequencies
                              (85Hz-3400Hz)
                            </li>
                            <li>
                              <strong>Debug Mode:</strong> Enables detailed logging for
                              troubleshooting
                            </li>
                          </ul>
                        </ion-card-content>
                      </ion-card>

                      <ion-item>
                        <ion-checkbox
                          [checked]="advancedVADEnabled()"
                          (ionChange)="toggleAdvancedVAD()"
                        >
                        </ion-checkbox>
                        <ion-label class="ion-margin-start">Enable Advanced VAD</ion-label>
                      </ion-item>

                      @if (advancedVADEnabled()) {
                        <ion-item>
                          <ion-label>
                            VAD Window: {{ vadWindowSize() }} frames (~{{ vadWindowSize() * 50 }}ms
                            latency)
                          </ion-label>
                          <ion-range
                            min="3"
                            max="20"
                            step="1"
                            [value]="vadWindowSize()"
                            (ionInput)="updateVadWindowSize($event.detail.value)"
                            pin="true"
                            snaps="true"
                          >
                            <ion-label slot="start">3</ion-label>
                            <ion-label slot="end">20</ion-label>
                          </ion-range>
                        </ion-item>

                        <ion-item>
                          <ion-checkbox
                            [checked]="voiceBandFilterEnabled()"
                            (ionChange)="toggleVoiceBandFilter()"
                          >
                          </ion-checkbox>
                          <ion-label class="ion-margin-start">
                            Voice Band Filter (85Hz-3400Hz)
                            <ion-note>Reduces background noise outside human voice range</ion-note>
                          </ion-label>
                        </ion-item>

                        <ion-item>
                          <ion-checkbox
                            [checked]="vadDebugMode()"
                            (ionChange)="toggleVadDebugMode()"
                          >
                          </ion-checkbox>
                          <ion-label class="ion-margin-start">
                            Debug Mode
                            <ion-note>Enables detailed VAD logging for troubleshooting</ion-note>
                          </ion-label>
                        </ion-item>

                        <ion-button
                          expand="block"
                          fill="outline"
                          color="tertiary"
                          (click)="configureUnifiedWaveform()"
                        >
                          Apply Advanced VAD Settings
                        </ion-button>
                      }
                    }
                  }
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>

          <!-- Waveform Visualization -->
          <div class="waveform-container">
            <h4>Growing Waveform Data</h4>
            <p><strong>Max Level:</strong> {{ maxWaveformLevel() | number: '1.3-3' }}</p>
            <p><strong>History Length:</strong> {{ waveformHistory().length }} levels</p>
            <p><strong>Display Bars:</strong> {{ waveformBars() }}</p>

            <!-- Continuous Emission Statistics -->
            <div class="emission-stats">
              <h5>Continuous Emission (50ms intervals)</h5>
              <p><strong>Total Emissions:</strong> {{ totalEmissions() }}</p>
              <p><strong>Silence Emissions:</strong> {{ silenceEmissions() }}</p>
              <p>
                <strong>Speech Ratio:</strong>
                {{
                  totalEmissions() > 0
                    ? (((totalEmissions() - silenceEmissions()) / totalEmissions()) * 100
                        | number: '1.1-1') + '%'
                    : 'N/A'
                }}
              </p>
              <p>
                <strong>Current State:</strong>
                <ion-chip [color]="silenceDetected() ? 'medium' : 'success'">
                  {{ silenceDetected() ? 'Silence (level = 0)' : 'Audio Detected' }}
                </ion-chip>
              </p>
            </div>

            @if (waveformEnabled()) {
              <div class="waveform-bars">
                @for (level of waveformVisualizationData(); track $index) {
                  <div
                    class="waveform-bar"
                    [style.height.%]="level === 0 ? 5 : level * 100"
                    [style.background-color]="
                      level === 0
                        ? '#cccccc'
                        : level > 0.8
                          ? '#f04141'
                          : level > 0.5
                            ? '#ffc409'
                            : '#2dd36f'
                    "
                    [title]="
                      level === 0
                        ? 'Silence (level = 0)'
                        : 'Audio level: ' + (level | number: '1.3-3')
                    "
                  ></div>
                }
              </div>

              @if (waveformHistory().length === 0) {
                <ion-note>
                  <p>
                    Start recording to see real-time continuous waveform data (50ms intervals)...
                  </p>
                  <p><em>Silence will show as level = 0 instead of being omitted</em></p>
                </ion-note>
              }
            } @else {
              <ion-note>
                <p>Waveform visualization is disabled. Enable it above to see live audio levels.</p>
              </ion-note>
            }
          </div>

          <!-- Raw Data Display -->
          <ion-accordion-group>
            <ion-accordion value="raw-data">
              <ion-item slot="header" color="light">
                <ion-label>Growing Waveform History</ion-label>
              </ion-item>
              <div class="ion-padding" slot="content">
                <pre class="raw-data">{{ waveformHistory() | json }}</pre>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </ion-card-content>
      </ion-card>
    }

    <!-- Intelligent Waveform Tab -->
    @if (activeTab() === 'intelligent-waveform') {
      <app-intelligent-waveform></app-intelligent-waveform>
    }
  }
</ion-content>
