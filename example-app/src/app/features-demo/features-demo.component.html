<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Native Audio Engine Demo</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Permission Check Section -->
  <ion-button expand="block" fill="outline" color="medium" (click)="openSettings()">
    <ion-icon name="settings" slot="start"></ion-icon>
    Open App Permissions
  </ion-button>

  <!-- Main Permission Check -->
  <ion-button expand="block" fill="outline" color="medium" (click)="checkPermission()">
    Check All Permissions
  </ion-button>

  <!-- Individual Permission Checks -->
  <ion-grid>
    <ion-row>
      <ion-col size="6">
        <ion-button
          expand="block"
          fill="outline"
          size="small"
          (click)="checkMicrophonePermission()"
        >
          <ion-icon name="mic-circle" slot="start"></ion-icon>
          Microphone
        </ion-button>
      </ion-col>
      <ion-col size="6">
        <ion-button
          expand="block"
          fill="outline"
          size="small"
          (click)="checkNotificationPermission()"
        >
          <ion-icon name="notifications-circle" slot="start"></ion-icon>
          Notifications
        </ion-button>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Permission Status Display -->
  @if (permissionChecked()) {
    <ion-card>
      <ion-card-header>
        <ion-card-title>Permission Status</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-icon
            name="mic-circle"
            slot="start"
            [color]="microphonePermissionStatus() === 'granted' ? 'success' : 'danger'"
          ></ion-icon>
          <ion-label>
            <h3>Microphone</h3>
            <p>{{ microphonePermissionStatus() | titlecase }}</p>
          </ion-label>
          <ion-chip
            [color]="microphonePermissionStatus() === 'granted' ? 'success' : 'danger'"
            slot="end"
          >
            {{ microphonePermissionStatus() }}
          </ion-chip>
        </ion-item>
        <ion-item>
          <ion-icon
            name="notifications-circle"
            slot="start"
            [color]="notificationPermissionStatus() === 'granted' ? 'success' : 'warning'"
          ></ion-icon>
          <ion-label>
            <h3>Notifications</h3>
            <p>{{ notificationPermissionStatus() | titlecase }}</p>
          </ion-label>
          <ion-chip
            [color]="
              notificationPermissionStatus() === 'granted'
                ? 'success'
                : notificationPermissionStatus() === 'unsupported'
                  ? 'medium'
                  : 'warning'
            "
            slot="end"
          >
            {{ notificationPermissionStatus() }}
          </ion-chip>
        </ion-item>
        @if (detailedPermissionInfo()) {
          <ion-item>
            <ion-label>
              <h3>Overall Status</h3>
              <p>
                All required permissions:
                {{ detailedPermissionInfo().granted ? 'Granted' : 'Not Granted' }}
              </p>
            </ion-label>
            <ion-icon
              [name]="detailedPermissionInfo().granted ? 'checkmark-circle' : 'close-circle'"
              [color]="detailedPermissionInfo().granted ? 'success' : 'danger'"
              slot="end"
            ></ion-icon>
          </ion-item>
        }
      </ion-card-content>
    </ion-card>
  }
  @if (!hasPermission()) {
    <ion-card color="warning">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="settings"></ion-icon>
          Microphone Permission Required
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>This app needs microphone permission to record audio.</p>
        <ion-button expand="block" fill="solid" (click)="requestPermission()">
          Request Permission
        </ion-button>
        <ion-note>
          <p>
            <small
              >If permission was denied, you can open app permissions to manually enable microphone
              access.</small
            >
          </p>
        </ion-note>
      </ion-card-content>
    </ion-card>
  } @else {
    <!-- Main Content -->
    <div>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="recording"
        (click)="selectTab('recording')"
      >
        <ion-icon name="mic-circle"></ion-icon>
        <ion-label>Recording</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="playback"
        (click)="selectTab('playback')"
      >
        <ion-icon name="musical-notes"></ion-icon>
        <ion-label>Playback</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="microphones"
        (click)="selectTab('microphones')"
      >
        <ion-icon name="volume-high"></ion-icon>
        <ion-label>Microphones</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="audio-info"
        (click)="selectTab('audio-info')"
      >
        <ion-icon name="information-circle"></ion-icon>
        <ion-label>Audio Info</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="waveform"
        (click)="selectTab('waveform')"
      >
        <ion-icon name="pulse"></ion-icon>
        <ion-label>Waveform</ion-label>
      </ion-button>
      <ion-button
        class="ion-no-padding ion-no-margin"
        value="intelligent-waveform"
        (click)="selectTab('intelligent-waveform')"
      >
        <ion-icon name="analytics"></ion-icon>
        <ion-label>Smart Buffer</ion-label>
      </ion-button>
    </div>
    {{ activeTab() }}

    <!-- Recording Tab -->
    @if (activeTab() === 'recording') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="mic-circle"></ion-icon>
            Audio Recording
          </ion-card-title>
          <ion-card-subtitle>Record audio with real-time monitoring</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <!-- Recording Status Display -->
          <ion-card color="light">
            <ion-card-content>
              <ion-item lines="none">
                <ion-label>
                  <h3>Recording Status</h3>
                  <p>
                    <ion-chip
                      [color]="
                        recordingStatus() === 'recording'
                          ? 'success'
                          : recordingStatus() === 'paused'
                            ? 'warning'
                            : recordingStatus() === 'stopped'
                              ? 'danger'
                              : 'medium'
                      "
                    >
                      <ion-icon
                        [name]="
                          recordingStatus() === 'recording'
                            ? 'radio-button-on'
                            : recordingStatus() === 'paused'
                              ? 'pause'
                              : recordingStatus() === 'stopped'
                                ? 'stop'
                                : 'radio-button-off'
                        "
                      ></ion-icon>
                      <ion-label>{{ recordingStatus() | titlecase }}</ion-label>
                    </ion-chip>
                  </p>
                </ion-label>
              </ion-item>

              <!-- Duration Display -->
              @if (recordingStatus() === 'recording' || recordingStatus() === 'paused') {
                <ion-item lines="none">
                  <ion-label>
                    <h3>Duration</h3>
                    <p>
                      <strong>{{ formattedRecordingDuration() }}</strong>
                    </p>
                  </ion-label>
                </ion-item>
              }

              <!-- Wave Level Display -->
              @if (recordingStatus() === 'recording' || recordingStatus() === 'paused') {
                <ion-item lines="none">
                  <ion-label>
                    <h3>Audio Level</h3>
                    <ion-progress-bar
                      [value]="recordingWaveLevel()"
                      [color]="
                        recordingWaveLevel() > 0.8
                          ? 'danger'
                          : recordingWaveLevel() > 0.5
                            ? 'warning'
                            : 'success'
                      "
                    ></ion-progress-bar>
                    <p>
                      <small
                        >{{ recordingWaveLevelPercent() }}% (Max:
                        {{ recordingMaxWaveLevelComputed() }}%)</small
                      >
                    </p>
                  </ion-label>
                </ion-item>

                <!-- Wave Level Visualization -->
                <div class="recording-wave-level-display">
                  <div class="wave-level-history">
                    <ion-label><strong>Wave Level History:</strong></ion-label>
                    <div class="wave-level-bars">
                      @for (level of recordingWaveLevelVisualization(); track $index) {
                        <div
                          class="wave-level-mini-bar"
                          [style.height.%]="level * 100"
                          [style.background-color]="
                            level > 0.8 ? '#f04141' : level > 0.5 ? '#ffc409' : '#2dd36f'
                          "
                        ></div>
                      }
                    </div>
                  </div>
                </div>
              }

              <!-- File Information -->
              @if (recordingFilePath()) {
                <ion-item lines="none">
                  <ion-label>
                    <h3>File Information</h3>
                    <p>
                      <small class="file-path">{{ recordingFilePath() }}</small>
                    </p>
                    @if (recordingMimeType()) {
                      <p>
                        <small>Format: {{ recordingMimeType() }}</small>
                      </p>
                    }
                    @if (recordingEncoding()) {
                      <p>
                        <small>Encoding: {{ recordingEncoding() | uppercase }}</small>
                      </p>
                    }
                  </ion-label>
                </ion-item>
              }
            </ion-card-content>
          </ion-card>

          <!-- Control Buttons -->
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-button
                  expand="block"
                  fill="solid"
                  color="success"
                  [disabled]="!canStartRecording()"
                  (click)="startRecording()"
                >
                  <ion-icon name="mic-circle" slot="start"></ion-icon>
                  Start Recording
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button
                  expand="block"
                  fill="solid"
                  color="warning"
                  [disabled]="!canPauseRecording()"
                  (click)="pauseRecording()"
                >
                  <ion-icon name="pause" slot="start"></ion-icon>
                  Pause
                </ion-button>
              </ion-col>
            </ion-row>
            <ion-row>
              <ion-col size="6">
                <ion-button
                  expand="block"
                  fill="solid"
                  color="secondary"
                  [disabled]="!canResumeRecording()"
                  (click)="resumeRecording()"
                >
                  <ion-icon name="play" slot="start"></ion-icon>
                  Resume
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button
                  expand="block"
                  fill="solid"
                  color="danger"
                  [disabled]="!canStopRecording()"
                  (click)="stopRecording()"
                >
                  <ion-icon name="stop" slot="start"></ion-icon>
                  Stop
                </ion-button>
              </ion-col>
            </ion-row>
            <ion-row>
              <ion-col size="6">
                <ion-button
                  expand="block"
                  fill="outline"
                  color="medium"
                  [disabled]="!canResetRecording()"
                  (click)="resetRecording()"
                >
                  <ion-icon name="refresh" slot="start"></ion-icon>
                  Reset Recording
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button
                  expand="block"
                  fill="outline"
                  color="primary"
                  [disabled]="!canGetRecordingStatus()"
                  (click)="getRecordingStatus()"
                >
                  <ion-icon name="information-circle" slot="start"></ion-icon>
                  Get Status
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>

          <!-- Instructions -->
          <ion-card color="light">
            <ion-card-content>
              <ion-label>
                <h3><ion-icon name="information-circle"></ion-icon> How to use:</h3>
                <ol style="padding-left: 20px; margin-top: 8px">
                  <li>Click <strong>Start Recording</strong> to begin recording</li>
                  <li>Use <strong>Pause</strong> to temporarily stop recording</li>
                  <li>Use <strong>Resume</strong> to continue recording</li>
                  <li>Click <strong>Stop</strong> to finish and save the recording</li>
                  <li>Use <strong>Reset Recording</strong> to restart with cleared data</li>
                  <li>Use <strong>Get Status</strong> to view current recording information</li>
                </ol>
              </ion-label>
            </ion-card-content>
          </ion-card>

          <!-- Recording Details (when stopped) -->
          @if (recordingDetails() && recordingStatus() === 'stopped') {
            <ion-card color="success">
              <ion-card-header>
                <ion-card-title>
                  <ion-icon name="checkmark-circle"></ion-icon>
                  Recording Completed
                </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <ion-item lines="none">
                  <ion-label>
                    <h3>Status</h3>
                    <p>{{ recordingDetails()!.status | titlecase }}</p>
                  </ion-label>
                </ion-item>
                @if (recordingDetails()!.endedAt) {
                  <ion-item lines="none">
                    <ion-label>
                      <h3>Ended At</h3>
                      <p>{{ recordingDetails()!.endedAt | date: 'short' }}</p>
                    </ion-label>
                  </ion-item>
                }
                @if (recordingDetails()!.path) {
                  <ion-item lines="none">
                    <ion-label>
                      <h3>File Path</h3>
                      <p class="file-path">{{ recordingDetails()!.path }}</p>
                    </ion-label>
                  </ion-item>
                }
                @if (recordingDetails()!.mimeType) {
                  <ion-item lines="none">
                    <ion-label>
                      <h3>MIME Type</h3>
                      <p>{{ recordingDetails()!.mimeType }}</p>
                    </ion-label>
                  </ion-item>
                }
              </ion-card-content>
            </ion-card>

            <!-- Recorded File Actions Card -->
            @if (showRecordedFileActions() && lastRecordedAudioFile()) {
              <ion-card color="tertiary">
                <ion-card-header>
                  <ion-card-title>
                    <ion-icon name="musical-notes"></ion-icon>
                    Recorded Audio Actions
                  </ion-card-title>
                  <ion-card-subtitle>
                    {{ lastRecordedAudioFile()!.filename }} ({{
                      lastRecordedAudioFile()!.duration.toFixed(2)
                    }}s)
                  </ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                  <ion-grid>
                    <ion-row>
                      <ion-col size="6">
                        <ion-button
                          expand="block"
                          fill="outline"
                          color="primary"
                          (click)="trimRecordedAudio()"
                        >
                          <ion-icon name="cut" slot="start"></ion-icon>
                          Trim
                        </ion-button>
                      </ion-col>
                      <ion-col size="6">
                        <ion-button
                          expand="block"
                          fill="outline"
                          [color]="
                            isFilePreloaded(lastRecordedAudioFile()!.uri) ? 'success' : 'primary'
                          "
                          [disabled]="isFilePreloaded(lastRecordedAudioFile()!.uri)"
                          (click)="preloadRecordedAudio(lastRecordedAudioFile()!)"
                        >
                          <ion-icon
                            [name]="
                              isFilePreloaded(lastRecordedAudioFile()!.uri)
                                ? 'checkmark-circle'
                                : 'download'
                            "
                            slot="start"
                          ></ion-icon>
                          {{
                            isFilePreloaded(lastRecordedAudioFile()!.uri) ? 'Preloaded' : 'Preload'
                          }}
                        </ion-button>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <ion-button
                          expand="block"
                          fill="solid"
                          color="success"
                          (click)="playRecordedAudio(lastRecordedAudioFile()!)"
                        >
                          <ion-icon name="play" slot="start"></ion-icon>
                          Play Audio
                        </ion-button>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <ion-button
                          expand="block"
                          fill="clear"
                          size="small"
                          color="medium"
                          (click)="dismissRecordedFileActions()"
                        >
                          <ion-icon name="close-circle" slot="start"></ion-icon>
                          Dismiss
                        </ion-button>
                      </ion-col>
                    </ion-row>
                  </ion-grid>

                  <!-- File Details -->
                  <ion-item lines="none">
                    <ion-label>
                      <p>
                        <strong>Size:</strong>
                        {{ (lastRecordedAudioFile()!.size / 1024).toFixed(2) }} KB
                      </p>
                      <p><strong>Format:</strong> {{ lastRecordedAudioFile()!.mimeType }}</p>
                      <p>
                        <strong>Sample Rate:</strong> {{ lastRecordedAudioFile()!.sampleRate }} Hz
                      </p>
                      <p><strong>Channels:</strong> {{ lastRecordedAudioFile()!.channels }}</p>
                      @if (isFilePreloaded(lastRecordedAudioFile()!.uri)) {
                        <p>
                          <ion-chip color="success" size="small">
                            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                            Track Ready for Playback
                          </ion-chip>
                        </p>
                      }
                    </ion-label>
                  </ion-item>
                </ion-card-content>
              </ion-card>
            }

            <!-- Playback Controls for Recorded Audio -->
            @if (currentRecordedFile()) {
              <ion-card>
                <ion-card-header>
                  <ion-card-title>
                    <ion-icon name="musical-notes"></ion-icon>
                    Playback Controls
                  </ion-card-title>
                  <ion-card-subtitle>{{ currentRecordedFile()!.filename }}</ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                  <!-- Playback Status -->
                  <ion-item lines="none">
                    <ion-label>
                      <h3>Playback Status</h3>
                      <p>
                        <ion-chip [color]="isRecordedAudioPlaying() ? 'success' : 'medium'">
                          <ion-icon [name]="isRecordedAudioPlaying() ? 'play' : 'pause'"></ion-icon>
                          <ion-label>{{
                            isRecordedAudioPlaying() ? 'Playing' : 'Stopped'
                          }}</ion-label>
                        </ion-chip>
                      </p>
                    </ion-label>
                  </ion-item>

                  <!-- Progress Bar -->
                  @if (recordedAudioPlaybackInfo()) {
                    <div class="progress-section">
                      <ion-range
                        [value]="recordedPlaybackProgress()"
                        [min]="0"
                        [max]="100"
                        [pin]="true"
                        [snaps]="false"
                        [ticks]="false"
                        (ionKnobMoveEnd)="onRecordedSeekChange($event)"
                        color="primary"
                      >
                        <ion-label slot="start">{{
                          formatTime(recordedPlaybackPosition())
                        }}</ion-label>
                        <ion-label slot="end">{{ formatTime(recordedTrackDuration()) }}</ion-label>
                      </ion-range>
                    </div>
                  }

                  <!-- Playback Control Buttons -->
                  <ion-grid>
                    <ion-row>
                      <ion-col size="4">
                        <ion-button
                          expand="block"
                          fill="solid"
                          color="success"
                          [disabled]="isRecordedAudioPlaying()"
                          (click)="playRecordedAudio(currentRecordedFile()!)"
                        >
                          <ion-icon name="play"></ion-icon>
                        </ion-button>
                        <ion-label class="button-label">Play</ion-label>
                      </ion-col>
                      <ion-col size="4">
                        <ion-button
                          expand="block"
                          fill="solid"
                          color="warning"
                          [disabled]="!isRecordedAudioPlaying()"
                          (click)="pauseRecordedAudio(currentRecordedFile()!.uri)"
                        >
                          <ion-icon name="pause"></ion-icon>
                        </ion-button>
                        <ion-label class="button-label">Pause</ion-label>
                      </ion-col>
                      <ion-col size="4">
                        <ion-button
                          expand="block"
                          fill="solid"
                          color="danger"
                          [disabled]="!recordedAudioPlaybackInfo()"
                          (click)="stopRecordedAudio(currentRecordedFile()!.uri)"
                        >
                          <ion-icon name="stop"></ion-icon>
                        </ion-button>
                        <ion-label class="button-label">Stop</ion-label>
                      </ion-col>
                    </ion-row>
                  </ion-grid>

                  <!-- Quick Seek Buttons -->
                  @if (recordedAudioPlaybackInfo()) {
                    <div class="seek-buttons">
                      <ion-label><strong>Quick Seek:</strong></ion-label>
                      <ion-grid>
                        <ion-row>
                          <ion-col size="3">
                            <ion-button size="small" fill="clear" (click)="seekRecordedAudio(0)">
                              Start
                            </ion-button>
                          </ion-col>
                          <ion-col size="3">
                            <ion-button size="small" fill="clear" (click)="seekRecordedAudio(15)">
                              15s
                            </ion-button>
                          </ion-col>
                          <ion-col size="3">
                            <ion-button size="small" fill="clear" (click)="seekRecordedAudio(30)">
                              30s
                            </ion-button>
                          </ion-col>
                          <ion-col size="3">
                            <ion-button
                              size="small"
                              fill="clear"
                              (click)="seekRecordedAudio(recordedTrackDuration() / 2)"
                            >
                              50%
                            </ion-button>
                          </ion-col>
                        </ion-row>
                      </ion-grid>
                    </div>
                  }

                  <!-- Audio File Details -->
                  @if (currentRecordedFile()) {
                    <ion-card color="light" style="margin-top: 16px">
                      <ion-card-content>
                        <ion-grid>
                          <ion-row>
                            <ion-col size="6">
                              <ion-label>
                                <h3>Duration</h3>
                                <p>{{ formatTime(currentRecordedFile()!.duration) }}</p>
                              </ion-label>
                            </ion-col>
                            <ion-col size="6">
                              <ion-label>
                                <h3>File Size</h3>
                                <p>{{ formatFileSize(currentRecordedFile()!.size) }}</p>
                              </ion-label>
                            </ion-col>
                          </ion-row>
                          <ion-row>
                            <ion-col size="6">
                              <ion-label>
                                <h3>Sample Rate</h3>
                                <p>{{ currentRecordedFile()!.sampleRate }} Hz</p>
                              </ion-label>
                            </ion-col>
                            <ion-col size="6">
                              <ion-label>
                                <h3>Channels</h3>
                                <p>
                                  {{ currentRecordedFile()!.channels === 1 ? 'Mono' : 'Stereo' }}
                                </p>
                              </ion-label>
                            </ion-col>
                          </ion-row>
                        </ion-grid>
                      </ion-card-content>
                    </ion-card>
                  }
                </ion-card-content>
              </ion-card>
            }
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- Audio Info Tab -->
    @if (activeTab() === 'audio-info') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="information-circle"></ion-icon>
            Audio File Information
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @if (recordedFiles().length > 0) {
            <ion-list>
              @for (file of recordedFiles(); track file.uri) {
                <ion-item>
                  <ion-label (click)="selectedAudioInfo.set(file)">
                    <h3>{{ file.filename }}</h3>
                    <p>{{ formatTime(file.duration) }} â€¢ {{ formatFileSize(file.size) }}</p>
                  </ion-label>
                  <div slot="end" style="display: flex; align-items: center; gap: 8px">
                    @if (hasFileInfo(file.uri)) {
                      @if (isFilePreloaded(file.uri)) {
                        <ion-icon
                          name="cloud-download"
                          color="success"
                          size="small"
                          title="Preloaded"
                        ></ion-icon>
                      } @else {
                        <ion-button
                          fill="clear"
                          size="small"
                          (click)="preloadRecordedAudio(file)"
                          title="Preload"
                        >
                          <ion-icon name="cloud-download" slot="icon-only"></ion-icon>
                        </ion-button>
                      }
                      <ion-button fill="clear" size="small" (click)="trimAudio(file)" title="Trim">
                        <ion-icon name="cut" slot="icon-only"></ion-icon>
                      </ion-button>
                    }
                    @if (selectedAudioInfo() === file) {
                      <ion-icon name="checkmarkCircle" color="success"></ion-icon>
                    }
                  </div>
                </ion-item>
              }
            </ion-list>

            @if (selectedAudioInfo()) {
              <ion-card color="light">
                <ion-card-header>
                  <ion-card-title>{{ selectedAudioInfo()!.filename }}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                  <ion-grid>
                    <ion-row>
                      <ion-col size="6">
                        <ion-label>
                          <h3>Duration</h3>
                          <p>{{ formatTime(selectedAudioInfo()!.duration) }}</p>
                        </ion-label>
                      </ion-col>
                      <ion-col size="6">
                        <ion-label>
                          <h3>File Size</h3>
                          <p>{{ formatFileSize(selectedAudioInfo()!.size) }}</p>
                        </ion-label>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="6">
                        <ion-label>
                          <h3>Sample Rate</h3>
                          <p>{{ selectedAudioInfo()!.sampleRate }} Hz</p>
                        </ion-label>
                      </ion-col>
                      <ion-col size="6">
                        <ion-label>
                          <h3>Channels</h3>
                          <p>{{ selectedAudioInfo()!.channels === 1 ? 'Mono' : 'Stereo' }}</p>
                        </ion-label>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="6">
                        <ion-label>
                          <h3>Bitrate</h3>
                          <p>{{ selectedAudioInfo()!.bitrate / 1000 }}k bps</p>
                        </ion-label>
                      </ion-col>
                      <ion-col size="6">
                        <ion-label>
                          <h3>MIME Type</h3>
                          <p>{{ selectedAudioInfo()!.mimeType }}</p>
                        </ion-label>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <ion-label>
                          <h3>File Path</h3>
                          <p style="word-break: break-all">{{ selectedAudioInfo()!.path }}</p>
                        </ion-label>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </ion-card-content>
              </ion-card>
            }
          } @else {
            <ion-card color="light">
              <ion-card-content>
                <p>
                  No recorded files available. Record some audio first to see detailed information
                  here.
                </p>
              </ion-card-content>
            </ion-card>
          }
        </ion-card-content>
      </ion-card>

      <!-- App Permissions Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="settings"></ion-icon>
            App Permissions
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>Manage app permissions directly from your device's system settings.</p>
          <ion-button expand="block" fill="outline" (click)="openSettings()"
            >>>
            <ion-icon name="settings" slot="start"></ion-icon>
            Open App Permissions
          </ion-button>
          <ion-note>
            <p>
              <small>
                Use this to modify microphone permissions, notification settings, and other
                app-specific configurations. This is especially useful if you initially denied
                permissions and want to enable them later.
              </small>
            </p>
          </ion-note>
        </ion-card-content>
      </ion-card>
    }

    <!-- Microphones Tab -->
    @if (activeTab() === 'microphones') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="volume-high"></ion-icon>
            Microphone Availability
          </ion-card-title>
          <ion-card-subtitle>Check if microphone is ready for recording</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <!-- Check Microphone Button -->
          <ion-button
            expand="block"
            fill="solid"
            color="primary"
            (click)="checkMicAvailability()"
            [disabled]="micListLoading()"
          >
            <ion-icon name="refresh" slot="start"></ion-icon>
            {{ micListLoading() ? 'Checking...' : 'Check Microphone Availability' }}
          </ion-button>

          <!-- Microphone Availability Status -->
          @if (micAvailability()) {
            <ion-card
              [color]="micAvailability()!.isAvailable ? 'success' : 'warning'"
              class="ion-margin-top"
            >
              <ion-card-header>
                <ion-card-title>
                  <ion-icon
                    [name]="micAvailability()!.isAvailable ? 'checkmark-circle' : 'close-circle'"
                  ></ion-icon>
                  {{ micAvailability()!.isAvailable ? 'Microphone Available' : 'Microphone Busy' }}
                </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                @if (micAvailability()!.isAvailable) {
                  <p>
                    <ion-icon name="checkmark-circle" color="light"></ion-icon>
                    The microphone is ready and can be used for recording.
                  </p>
                } @else {
                  <p>
                    <ion-icon name="close-circle" color="light"></ion-icon>
                    The microphone is currently in use by another app or unavailable.
                  </p>
                  <p class="ion-margin-top">
                    <small>
                      <ion-icon name="information-circle"></ion-icon>
                      Please close other apps that might be using the microphone (voice memos, video
                      calls, etc.) and try again.
                    </small>
                  </p>
                }
              </ion-card-content>
            </ion-card>
          } @else {
            <!-- Instructions -->
            <ion-card color="light">
              <ion-card-content>
                <ion-label>
                  <h3><ion-icon name="information-circle"></ion-icon> Instructions:</h3>
                  <ol style="padding-left: 20px; margin-top: 8px">
                    <li>
                      Click <strong>Check Microphone Availability</strong> to test if the microphone
                      is ready for recording
                    </li>
                    <li>The check will detect if another app is currently using the microphone</li>
                    <li>If busy, close other apps and check again</li>
                  </ol>
                </ion-label>
              </ion-card-content>
            </ion-card>
          }

          <!-- Platform Information -->
          <ion-card color="tertiary">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="information-circle"></ion-icon>
                Platform Detection Methods
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item lines="none">
                  <ion-icon name="logo-android" slot="start" color="success"></ion-icon>
                  <ion-label>
                    <h3>Android 10+</h3>
                    <p>Checks active recordings + AudioRecord test</p>
                  </ion-label>
                </ion-item>
                <ion-item lines="none">
                  <ion-icon name="logo-android" slot="start" color="success"></ion-icon>
                  <ion-label>
                    <h3>Android (older)</h3>
                    <p>Tests MediaRecorder.AudioSource.MIC directly</p>
                  </ion-label>
                </ion-item>
                <ion-item lines="none">
                  <ion-icon name="logo-apple" slot="start" color="success"></ion-icon>
                  <ion-label>
                    <h3>iOS</h3>
                    <p>AVAudioEngine tap test + session activation</p>
                  </ion-label>
                </ion-item>
                <ion-item lines="none">
                  <ion-icon name="globe" slot="start" color="warning"></ion-icon>
                  <ion-label>
                    <h3>Web</h3>
                    <p>Basic device enumeration (limited support)</p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-card-content>
      </ion-card>
    }

    <!-- Waveform Tab -->
    @if (activeTab() === 'waveform') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="pulse"></ion-icon>
            Growing Waveform Visualization with Speech Detection
          </ion-card-title>
          <ion-card-subtitle>
            Real-time incremental audio levels with optional speech-only detection and Voice
            Activity Detection (VAD)
          </ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <!-- Unified Configuration -->
          <ion-card color="primary">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="settings" slot="start"></ion-icon>
                Unified Waveform Configuration
              </ion-card-title>
              <ion-card-subtitle>
                Configure all waveform features in one call using the new unified API
              </ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <ion-button
                expand="block"
                fill="solid"
                color="success"
                (click)="configureUnifiedWaveform()"
              >
                <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                Apply Unified Configuration
              </ion-button>
              <ion-note color="medium">
                <small>
                  This uses the new unified API that combines waveform, speech detection, VAD
                  settings, and gain factor for better visualization.
                </small>
              </ion-note>
            </ion-card-content>
          </ion-card>

          <!-- Legacy Configuration -->
          <ion-accordion-group>
            <ion-accordion value="legacy">
              <ion-item slot="header" color="light">
                <ion-label>Legacy Configuration (Deprecated)</ion-label>
              </ion-item>
              <div slot="content">
                <!-- Waveform Controls -->
                <div class="waveform-controls">
                  <ion-item>
                    <ion-checkbox
                      [checked]="waveformEnabled()"
                      (ionChange)="toggleWaveformEnabled()"
                    >
                    </ion-checkbox>
                    <ion-label class="ion-margin-start">Enable Waveform</ion-label>
                  </ion-item>

                  <ion-item>
                    <ion-label>Number of Bars: {{ waveformBars() }}</ion-label>
                    <ion-select
                      [value]="waveformBars()"
                      (ionChange)="updateWaveformBars($event.detail.value)"
                      interface="popover"
                    >
                      @for (option of waveformBarsOptions; track option) {
                        <ion-select-option [value]="option.value">{{
                          option.label
                        }}</ion-select-option>
                      }
                    </ion-select>
                  </ion-item>

                  <ion-item>
                    <ion-label>Emission Interval: {{ waveformIntervalSeconds() }}s</ion-label>
                  </ion-item>

                  <ion-button expand="block" fill="outline" (click)="resetWaveformLevels()">
                    <ion-icon name="refresh" slot="start"></ion-icon>
                    Reset Levels
                  </ion-button>

                  <ion-button
                    expand="block"
                    fill="clear"
                    color="danger"
                    (click)="destroyWaveform()"
                  >
                    <ion-icon name="close-circle" slot="start"></ion-icon>
                    Destroy Waveform
                  </ion-button>
                </div>

                <!-- Speech Detection Controls -->
                <div class="speech-detection-controls">
                  <ion-item-divider>
                    <ion-label>Speech Detection Settings</ion-label>
                  </ion-item-divider>

                  <ion-item>
                    <ion-checkbox
                      [checked]="speechDetectionEnabled()"
                      (ionChange)="toggleSpeechDetection()"
                    >
                    </ion-checkbox>
                    <ion-label class="ion-margin-start">Enable Speech-Only Detection</ion-label>
                  </ion-item>

                  @if (speechDetectionEnabled()) {
                    <ion-item>
                      <ion-label>Threshold: {{ speechThreshold() }}</ion-label>
                      <ion-select
                        [value]="speechThreshold()"
                        (ionChange)="updateSpeechThreshold($event.detail.value)"
                        interface="popover"
                      >
                        @for (option of speechThresholdOptions; track option) {
                          <ion-select-option [value]="option.value">{{
                            option.label
                          }}</ion-select-option>
                        }
                      </ion-select>
                    </ion-item>

                    <ion-item>
                      <ion-checkbox [checked]="useVAD()" (ionChange)="toggleVAD()"> </ion-checkbox>
                      <ion-label class="ion-margin-start"
                        >Use Voice Activity Detection (VAD)</ion-label
                      >
                    </ion-item>

                    @if (useVAD()) {
                      <ion-item>
                        <ion-label>Background Calibration: {{ calibrationDuration() }}ms</ion-label>
                        <ion-select
                          [value]="calibrationDuration()"
                          (ionChange)="updateCalibrationDuration($event.detail.value)"
                          interface="popover"
                        >
                          @for (option of calibrationDurationOptions; track option) {
                            <ion-select-option [value]="option.value">{{
                              option.label
                            }}</ion-select-option>
                          }
                        </ion-select>
                      </ion-item>

                      <!-- Advanced VAD Controls -->
                      <ion-item-divider color="light">
                        <ion-label>Advanced VAD Optimization</ion-label>
                      </ion-item-divider>
                    }
                  }
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>

          <!-- Waveform Visualization -->
          <div class="waveform-container">
            <h4>Growing Waveform Data</h4>
            <p><strong>Max Level:</strong> {{ maxWaveformLevel() | number: '1.3-3' }}</p>
            <p><strong>History Length:</strong> {{ waveformHistory().length }} levels</p>
            <p><strong>Display Bars:</strong> {{ waveformBars() }}</p>

            <!-- Continuous Emission Statistics -->
            <div class="emission-stats">
              <h5>Continuous Emission (50ms intervals)</h5>
              <p><strong>Total Emissions:</strong> {{ totalEmissions() }}</p>
              <p><strong>Silence Emissions:</strong> {{ silenceEmissions() }}</p>
              <p>
                <strong>Speech Ratio:</strong>
                {{
                  totalEmissions() > 0
                    ? (((totalEmissions() - silenceEmissions()) / totalEmissions()) * 100
                        | number: '1.1-1') + '%'
                    : 'N/A'
                }}
              </p>
              <p>
                <strong>Current State:</strong>
                <ion-chip [color]="silenceDetected() ? 'medium' : 'success'">
                  {{ silenceDetected() ? 'Silence (level = 0)' : 'Audio Detected' }}
                </ion-chip>
              </p>
            </div>

            @if (waveformEnabled()) {
              <div class="waveform-bars">
                @for (level of waveformVisualizationData(); track $index) {
                  <div
                    class="waveform-bar"
                    [style.height.%]="level === 0 ? 5 : level * 100"
                    [style.background-color]="
                      level === 0
                        ? '#cccccc'
                        : level > 0.8
                          ? '#f04141'
                          : level > 0.5
                            ? '#ffc409'
                            : '#2dd36f'
                    "
                    [title]="
                      level === 0
                        ? 'Silence (level = 0)'
                        : 'Audio level: ' + (level | number: '1.3-3')
                    "
                  ></div>
                }
              </div>

              @if (waveformHistory().length === 0) {
                <ion-note>
                  <p>
                    Start recording to see real-time continuous waveform data (50ms intervals)...
                  </p>
                  <p><em>Silence will show as level = 0 instead of being omitted</em></p>
                </ion-note>
              }
            } @else {
              <ion-note>
                <p>Waveform visualization is disabled. Enable it above to see live audio levels.</p>
              </ion-note>
            }
          </div>

          <!-- Raw Data Display -->
          <ion-accordion-group>
            <ion-accordion value="raw-data">
              <ion-item slot="header" color="light">
                <ion-label>Growing Waveform History</ion-label>
              </ion-item>
              <div class="ion-padding" slot="content">
                <pre class="raw-data">{{ waveformHistory() | json }}</pre>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </ion-card-content>
      </ion-card>
    }

    <!-- Intelligent Waveform Tab -->
    @if (activeTab() === 'intelligent-waveform') {
      <app-intelligent-waveform></app-intelligent-waveform>
    }
  }
</ion-content>
